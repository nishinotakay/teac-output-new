<!-- app/views/users/chat_gpts/shared/_chat_gpt_form.html.erb -->
<% if user_signed_in? %>
  <% if @chatgpt.new_record? %>
    <!-- 新規作成フォーム -->
    <div class="new-chatgpt-form-container">
      <h2>新しい質問を作成</h2>
      <%= form_with(model: @chatgpt, url: url, local: true) do |f| %>
        <div class="row mt-4">
          <div class="col-12">
            <%= f.label :prompt, "プロンプトを入力してください", class: "form-label" %>
            <%= f.text_area :prompt, class: "form-control", rows: 8, required: true, placeholder: "ここにプロンプトを入力..." %>
          </div>

          <!-- デフォルトのモードを設定するための隠しフィールド -->
          <%= f.hidden_field :mode, value: "teacher" %>

          <div class="col-12 text-center my-3">
            <%= f.submit btn_name, class: "btn btn-primary" %>
            <%= link_to 'キャンセル', users_chat_gpts_path, class: "btn btn-outline-dark" %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <!-- 続けて質問するフォームと既存の質問と回答の表示 -->
    <div class="show-page-container">
      <div class="main-content">
        <% title, content = extract_title_and_content(@chatgpt.content) %>
        <h4 class="show-page-title">質問詳細ページ</h4>
        <p>作成日：<%= @chatgpt.created_at.strftime("%Y/%m/%d %H:%M") %></p>
        <p>タイトル：<%= title %></p>
        <div class="show-page-card">
          <div class="show-page-card-body">
            <% if content.present? %>
              <% questions_and_answers = content.split("\n\n") %>
              <% questions_and_answers.each_with_index do |qa, index| %>
                <% question, answer = qa.split("\n回答：", 2) %>
                <div class="qa-block">
                  <p><strong>質問<%= index + 1 %>：</strong></p>
                  <p><%= question.strip if question.present? %></p>
                  <p><strong>回答<%= index + 1 %>：</strong></p>
                  <p><%= answer.strip if answer.present? %></p>
                </div>
                <hr>
              <% end %>
            <% end %>
          </div>
        </div>
        <div class="show-page-return-button">
          <%= link_to '戻る', users_chat_gpts_path, class: "btn btn-secondary" %>
          <% if @chatgpt.persisted? %>
            <%= link_to '削除', users_chat_gpt_path(@chatgpt), method: :delete, data: { confirm: "この質問を本当に削除してよろしいですか？" }, class: "btn btn-danger" %>
          <% end %>
        </div>
        <div class="form-group mt-3">
          <%= form_with url: continue_question_users_chat_gpt_path(@chatgpt), method: :post, local: true do %>
            <label for="new_prompt">続けて質問する</label>
            <textarea id="new_prompt" name="new_prompt" class="form-control" rows="3"></textarea>
            <%= hidden_field_tag :previous_response, @chatgpt.content %>
            <%= submit_tag '質問を続ける', class: 'btn btn-primary mt-2' %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
<% else %>
  <p class="show-page-login-alert">ログインしてください。</p>
  <%= link_to "ログイン", new_user_session_path, class: "btn btn-primary" %>
<% end %>
