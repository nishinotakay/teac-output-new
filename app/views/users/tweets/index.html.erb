<%= javascript_pack_tag "users/tweets","users/index_articles_and_dashboards" %>
<% provide(:title, "つぶやき一覧") %>
<% unless current_admin.present? %>
  <% number_of_comment_notifications = @comment_notifications.count %>
  <% if number_of_comment_notifications > 0 %>
  <!-- モーダルのトリガー -->
  <a class= "modalTrriger" href="#" data-bs-toggle="modal" data-bs-target="#commentNotificationModal">
    <%= number_of_comment_notifications %>件の未確認のコメントがあります。
  </a>
  <% end %>  
  <!-- モーダルの設定 -->
  <div class="modal fade" id="commentNotificationModal" tabindex="-1" aria-labelledby="commentNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="commentNotificationModalLabel">コメント通知一覧</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <ul class="list-group">
            <% @comment_notifications.each do |notification| %>
              <%= form_with url: confirmed_notification_users_tweet_tweet_comment_path(notification.tweet, notification), method: :patch, local: true, html: {class: "notification-form", id: "comment-#{notification.id}"} do |form| %>
                <li class="list-group-item">
                  <% image = current_user.profile.present? && current_user.profile.image.present? ? current_user.profile&.image : "user_default.png" %>
                  <div class="d-flex align-items-center">
                    <%= image_tag image , class: "rounded-circle", size: "60x60" %>
                    <div class="d-flex flex-column align-items-start">
                      <strong><%= notification.user.name %>さんがあなたのつぶやきにコメントしました。</strong>
                      <p><%= link_to "#{truncate(notification.content, omission: '...')}", "#", class: "notification-link" %></p>
                      <time class="timestamp" data-time="<%= notification.created_at.to_i %>"></time>
                    </div>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  </div>
<% end %>

<%= render "users/tweets/shared/tweets_table" %>

<div class="comment-form mt-4" style="max-width: 600px; margin: 0 auto;">
  <%= form_with(model: @comment, url: create_comment_users_tweets_path, local: true, html: { style: "display: flex; flex-direction: column; align-items: flex-start;" }) do |f| %>
    <div class="form-group" style="width: 100%;">
      <%= f.text_area :content, rows: 3, style: "width: 100%; resize: vertical; border-radius: 4px; border: 1px solid #ccc; padding: 8px;", placeholder: 'コメントを入力してください' %>
    </div>
    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-top: 10px;">
      <%= f.submit 'コメントする', class: 'btn btn-primary', style: "white-space: nowrap; padding: 6px 12px; font-size: 14px;" %>
      <span style="color: #666; font-size: 14px; margin-top: 5px;">〜コメント一覧〜</span>
    </div>
  <% end %>
</div>
<!-- 〜コメント一覧〜 -->
<div class="comments-list mt-4">
  <h3>〜コメント一覧〜</h3>
  <% @tweets.each do |tweet| %>
    <div class="tweet-comments mb-4">
      <h4>つぶやき: <%= tweet.post %></h4>
      <% tweet.tweet_comments.order(created_at: :desc).each do |comment| %>
        <div class="comment mb-2">
          <p><strong><%= comment.user.name %>:</strong> <%= comment.content %></p>
          <small><%= comment.created_at.strftime('%Y-%m-%d %H:%M') %></small>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div id="new" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>
<div id="edit" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>